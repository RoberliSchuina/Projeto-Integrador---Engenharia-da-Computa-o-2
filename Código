/*
 * Programa: Controle de Acesso Inteligente com Foco em Eficiência Energética
 * Funcionalidades:
 * - Leitura RFID (MFRC522)
 * - Controle de cancela (Servo)
 * - Acionamento de Relé LIGA com cartão, DESLIGA com botão.
 * - Feedback sonoro (Buzzer Ativo)
 * - Display (LCD I2C) com Letreiro Ocioso
 * - Display mostra "SALA EM USO"
 * - Relógio (RTC DS1302)
 */

#include <SPI.h>
#include <MFRC522.h>
#include <Servo.h>
// Bibliotecas de Comunicação e Periféricos
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <RtcDS1302.h>
// Necessário para o objeto ThreeWire
#include <ThreeWire.h>

// --- MFRC522 ---
#define SS_PIN 10
#define RST_PIN 9
MFRC522 mfrc522(SS_PIN, RST_PIN);

// --- Configuração do Buzzer, LEDs e Relé ---
#define BUZZER_PIN A0  // Buzzer Ativo (Pino A0)
#define RELE_PIN A1    // Pino de controle do Relé 5V (Ventoinha) - Active HIGH

// --- Botão de Desligamento ---
#define BOTAO_DESLIGA_PIN A2 // Pino para o botão de desligar

// --- Pinos do LED RGB (HW-479 Cátodo Comum) ---
#define RGB_R_PIN 6    // Pino VERMELHO do LED RGB
#define RGB_G_PIN 5    // Pino VERDE do LED RGB
#define RGB_B_PIN 2    // Pino AZUL do LED RGB (para estado Ocioso)

// --- Configuração do Servo ---
Servo microservo9g; // Conectado ao Pino 3

// --- Configuração do RTC DS1302 ---
#define RTC_RST_PIN 4  // Digital 4 (CE/Reset)
#define RTC_IO_PIN 7   // Digital 7 (I/O/Data)
#define RTC_SCLK_PIN 8 // Digital 8 (SCLK/Clock)

ThreeWire myWire(RTC_IO_PIN, RTC_SCLK_PIN, RTC_RST_PIN);
RtcDS1302<ThreeWire> Rtc(myWire);

// --- Configuração do LCD I2C ---
LiquidCrystal_I2C lcd(0x27, 16, 2); // Endereço 0x27, 16x2

// --- Variáveis de Controle do Letreiro Ocioso ---
unsigned long lastDisplayChange = 0;
const long displayInterval = 3000;
bool showScreenA = true;

// --- Variável de Estado do Sistema ---
bool isSistemaAtivo = false; // Controla se a energia (Relé) está LIGADA ou DESLIGADA

// --- FUNÇÕES DE FEEDBACK ---

void beepLiberado() {
  digitalWrite(BUZZER_PIN, HIGH);
  delay(100);
  digitalWrite(BUZZER_PIN, LOW);
}

void beepNegado() {
  digitalWrite(BUZZER_PIN, HIGH);
  delay(100);
  digitalWrite(BUZZER_PIN, LOW);
  delay(50);
  digitalWrite(BUZZER_PIN, HIGH);
  delay(100);
  digitalWrite(BUZZER_PIN, LOW);
}

void setRgbColor(bool r, bool g, bool b) {
  digitalWrite(RGB_R_PIN, r);
  digitalWrite(RGB_G_PIN, g);
  digitalWrite(RGB_B_PIN, b);
}

// --- FUNÇÕES DE DISPLAY ---

// Função para exibir a data/hora do ACESSO LIBERADO
void displayTime(RtcDateTime t) {
  lcd.clear();
  lcd.setCursor(0, 0);
  if (t.Day() < 10) lcd.print("0");
  lcd.print(t.Day());
  lcd.print("/");
  if (t.Month() < 10) lcd.print("0");
  lcd.print(t.Month());
  lcd.print("/");
  lcd.print(t.Year());
  lcd.setCursor(0, 1);
  if (t.Hour() < 10) lcd.print("0");
  lcd.print(t.Hour());
  lcd.print(":");
  if (t.Minute() < 10) lcd.print("0");
  lcd.print(t.Minute());
  lcd.print(":");
  if (t.Second() < 10) lcd.print("0");
  lcd.print(t.Second());
  lcd.print(" LIBERADO");
}

// --- FUNÇÕES DO LETREIRO OCIOSO ---

// Função para a Tela A (Projeto)
void displayScreenA() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("PROJ. INTEGRADOR");
  lcd.setCursor(0, 1);
  lcd.print("APROXIMAR CARTAO");
}

// Função para a Tela B (Relógio)
void displayScreenB(RtcDateTime t) {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Data: ");
  if (t.Day() < 10) lcd.print("0");
  lcd.print(t.Day());
  lcd.print("/");
  if (t.Month() < 10) lcd.print("0");
  lcd.print(t.Month());
  lcd.print("/");
  lcd.print(t.Year());
  lcd.setCursor(0, 1);
  lcd.print("Hora: ");
  if (t.Hour() < 10) lcd.print("0");
  lcd.print(t.Hour());
  lcd.print(":");
  if (t.Minute() < 10) lcd.print("0");
  lcd.print(t.Minute());
  lcd.print(":");
  if (t.Second() < 10) lcd.print("0");
  lcd.print(t.Second());
}

// Função para a Tela de Sistema Ativo
void displaySistemaAtivo() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("SALA EM USO"); // REQUISITO: Nova Mensagem
  lcd.setCursor(0, 1);
  lcd.print("Energia Ligada");
}

// Função que roda o Letreiro (separada do loop)
void atualizarLetreiroOcioso() {
  unsigned long currentMillis = millis();
  if (currentMillis - lastDisplayChange >= displayInterval)
  {
    lastDisplayChange = currentMillis;
    if (showScreenA) {
      RtcDateTime now = Rtc.GetDateTime();
      displayScreenB(now);
      showScreenA = false;
    } else {
      displayScreenA();
      showScreenA = true;
    }
  }
}

// Função que processa o cartão (separada do loop)
void processarCartao() {
  RtcDateTime t = Rtc.GetDateTime();

  String conteudo = "";
  for (byte i = 0; i < mfrc522.uid.size; i++)
  {
    conteudo.concat(String(mfrc522.uid.uidByte[i] < 0x10 ? " 0" : " "));
    conteudo.concat(String(mfrc522.uid.uidByte[i], HEX));
  }
  conteudo.toUpperCase();
  String uid = conteudo.substring(1);
  Serial.print("UID lido: ");
  Serial.println(uid);

  // --- Verificacao de Acesso Liberado ---
  // UIDs Permitidos: 91 42 91 04, 77 E7 7B 05
  if (uid == "91 42 91 04" || uid == "77 E7 7B 05")
  {
    beepLiberado();
    displayTime(t);
    Serial.print("ACESSO LIBERADO: ");
    Serial.print(t.Year()); Serial.print("/"); Serial.print(t.Month()); Serial.print("/"); Serial.print(t.Day());
    Serial.print(" ");
    Serial.print(t.Hour()); Serial.print(":"); Serial.print(t.Minute()); Serial.print(":"); Serial.println(t.Second());

    // --- Ação de Acesso ---
    microservo9g.write(0);
    setRgbColor(LOW, HIGH, LOW);
    
    // LÓGICA ACTIVE HIGH: HIGH = LIGA
    digitalWrite(RELE_PIN, HIGH);
    isSistemaAtivo = true;
    Serial.println("Rele ACIONADO (Ventoinha Ligada)");

    delay(3000); // Tempo para a pessoa passar

    // --- Fecha a cancela, mas MANTÉM A ENERGIA ---
    microservo9g.write(90);
    
    // Atualiza o display para "Sala Ocupada"
    displaySistemaAtivo();
  }

  // --- Verificacao de Acesso Negado ---
  else
  {
    beepNegado();
    setRgbColor(LOW, LOW, LOW);

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("ACESSO NEGADO!");
    
    bool isKnownDenied = (uid == "E1 1B 09 05");
    if (isKnownDenied) {
      Serial.println("Cartao Negado Conhecido.");
      lcd.setCursor(0, 1);
      lcd.print("Cartao Bloqueado");
    } else {
      Serial.println("TAG Desconhecida.");
      lcd.setCursor(0, 1);
      lcd.print("Cartao Desconhecido");
    }

    for (int i = 0; i < 4 ; i++)
    {
      setRgbColor(HIGH, LOW, LOW);
      delay(200);
      setRgbColor(LOW, LOW, LOW);
      delay(200);
    }
    delay(1000);

    // Retorna ao estado anterior (Ativo ou Ocioso)
    if (isSistemaAtivo) {
      setRgbColor(LOW, HIGH, LOW);
      displaySistemaAtivo();
    } else {
      setRgbColor(LOW, LOW, HIGH);
      displayScreenA();
      lastDisplayChange = millis();
      showScreenA = true;
    }
  }

  mfrc522.PICC_HaltA();
  mfrc522.PCD_StopCrypto1();
}

// Função que verifica o botão de desligar
void verificarBotaoDesligamento() {
  if (digitalRead(BOTAO_DESLIGA_PIN) == LOW) {
    Serial.println("Botão de desligamento pressionado!");
    
    // Ação de Desligamento
    digitalWrite(RELE_PIN, LOW); // LÓGICA ACTIVE HIGH: LOW = DESLIGA
    isSistemaAtivo = false;
    setRgbColor(LOW, LOW, HIGH);

    Serial.println("Rele DESLIGADO (Ventoinha Desligada)");

    // Prepara o "letreiro" para recomeçar
    displayScreenA();
    showScreenA = true;
    lastDisplayChange = millis();

    delay(200); // Debounce
  }
}


void setup()
{
  lcd.init();
  lcd.backlight();
  displayScreenA();
  lastDisplayChange = millis();

  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(RELE_PIN, OUTPUT);
  pinMode(RGB_R_PIN, OUTPUT);
  pinMode(RGB_G_PIN, OUTPUT);
  pinMode(RGB_B_PIN, OUTPUT);
  pinMode(BOTAO_DESLIGA_PIN, INPUT_PULLUP);

  // LÓGICA ACTIVE HIGH: Inicia o relé em LOW (Desligado)
  digitalWrite(RELE_PIN, LOW);
  isSistemaAtivo = false;

  setRgbColor(LOW, LOW, HIGH);

  Rtc.Begin();
  RtcDateTime compiled = RtcDateTime(__DATE__, __TIME__);
  if (!Rtc.IsDateTimeValid())
  {
    Serial.println("ERRO: RTC não está funcionando! Ajustando data/hora.");
    Rtc.SetDateTime(compiled);
  }
  // Rtc.SetDateTime(RtcDateTime(2025, 11, 7, 11, 45, 0));

  microservo9g.attach(3);
  microservo9g.write(90);

  Serial.begin(9600);
  SPI.begin();
  mfrc522.PCD_Init();
  Serial.println("Sistema Pronto e Aguardando Cartão...");
}

void loop()
{
  if (isSistemaAtivo) {
    verificarBotaoDesligamento();
  }

  if (mfrc522.PICC_IsNewCardPresent() && mfrc522.PICC_ReadCardSerial())
  {
    processarCartao();
  }
  else if (!isSistemaAtivo)
  {
    atualizarLetreiroOcioso();
  }
}
