/*
 * Programa: Controle de Acesso Inteligente com Foco em Eficiência Energética
 * Funcionalidades:
 * - Leitura RFID (MFRC522)
 * - Controle de cancela (Servo)
 * - Acionamento de Relé LIGA com cartão, DESLIGA com botão.
 * - Feedback sonoro (Buzzer Ativo)
 * - Display (LCD I2C) com Letreiro Ocioso
 * - Display mostra "SALA EM USO"
 * - Relógio (RTC DS1302)
 * - Botão -> Desliga Relé e Gera RELATÓRIO DE CONSUMO DETALHADO
 * - Cálculo de consumo baseado em carga real (AC + Lâmpadas)
 * - Feedback de Display Aprimorado 
 */

#include <SPI.h>
#include <MFRC522.h>
#include <Servo.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <RtcDS1302.h>
#include <ThreeWire.h>

// --- MFRC522 ---
#define SS_PIN 10
#define RST_PIN 9
MFRC522 mfrc522(SS_PIN, RST_PIN);

// --- Configuração do Hardware ---
#define BUZZER_PIN A0
#define RELE_PIN A1    // Active HIGH (HIGH liga)
#define BOTAO_DESLIGA_PIN A2

#define RGB_R_PIN 6
#define RGB_G_PIN 5
#define RGB_B_PIN 2

Servo microservo9g; // Pino 3

// --- RTC ---
#define RTC_RST_PIN 4
#define RTC_IO_PIN 7
#define RTC_SCLK_PIN 8
ThreeWire myWire(RTC_IO_PIN, RTC_SCLK_PIN, RTC_RST_PIN);
RtcDS1302<ThreeWire> Rtc(myWire);

// --- LCD ---
LiquidCrystal_I2C lcd(0x27, 16, 2);

// --- Variáveis de Controle ---
unsigned long lastDisplayChange = 0;
const long displayInterval = 3000;
bool showScreenA = true;
bool isSistemaAtivo = false;

// --- DADOS DE CONSUMO E TARIFA ---
unsigned long inicioUso = 0; // Marca o início da sessão

// 1 Ar Condicionado: 0,0885 kWh por hora
const float POTENCIA_AC_KW = 0.0885; 

// 6 Lâmpadas LED 18W: 0.108 kW
const float POTENCIA_LAMPADAS_KW = 0.108; 

// Potência Total da Sala
const float POTENCIA_TOTAL_KW = POTENCIA_AC_KW + POTENCIA_LAMPADAS_KW; 

// Tarifa de Energia (R$/kWh)
const float TARIFA_KWH = 0.682;

// --- FUNÇÕES AUXILIARES ---

void beepLiberado() {
  digitalWrite(BUZZER_PIN, HIGH); delay(100); digitalWrite(BUZZER_PIN, LOW);
}

void beepNegado() {
  digitalWrite(BUZZER_PIN, HIGH); delay(100); digitalWrite(BUZZER_PIN, LOW);
  delay(50);
  digitalWrite(BUZZER_PIN, HIGH); delay(100); digitalWrite(BUZZER_PIN, LOW);
}

void setRgbColor(bool r, bool g, bool b) {
  digitalWrite(RGB_R_PIN, r); digitalWrite(RGB_G_PIN, g); digitalWrite(RGB_B_PIN, b);
}

// --- TELAS DO LCD ---

void displayScreenA() {
  lcd.clear();
  lcd.setCursor(0, 0); lcd.print("PROJ. INTEGRADOR");
  lcd.setCursor(0, 1); lcd.print("APROXIMAR CARTAO");
}

void displayScreenB(RtcDateTime t) {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Data: ");
  if (t.Day() < 10) lcd.print("0"); lcd.print(t.Day()); lcd.print("/");
  if (t.Month() < 10) lcd.print("0"); lcd.print(t.Month()); lcd.print("/");
  lcd.print(t.Year());
  lcd.setCursor(0, 1);
  lcd.print("Hora: ");
  if (t.Hour() < 10) lcd.print("0"); lcd.print(t.Hour()); lcd.print(":");
  if (t.Minute() < 10) lcd.print("0"); lcd.print(t.Minute()); lcd.print(":");
  if (t.Second() < 10) lcd.print("0"); lcd.print(t.Second());
}

void displaySistemaAtivo() {
  lcd.clear();
  lcd.setCursor(0, 0); lcd.print("SALA OCUPADA");
  lcd.setCursor(0, 1); lcd.print("Monitorando...");
}

// --- Tela de Relatório de Sessão ---
void displayRelatorioConsumo(unsigned long duracaoMs) {
  float segundos = duracaoMs / 1000.0;
  float horas = segundos / 3600.0;
  
  float consumoKWh = POTENCIA_TOTAL_KW * horas;
  float custoReais = consumoKWh * TARIFA_KWH;

  // Tela 1: Tempo
  lcd.clear();
  lcd.setCursor(0, 0); lcd.print("Sessao Encerrada");
  lcd.setCursor(0, 1); 
  lcd.print("Tempo: "); lcd.print((int)segundos); lcd.print(" seg");
  delay(3000);

  // Tela 2: Consumo
  lcd.clear();
  lcd.setCursor(0, 0); lcd.print("Consumo Energia:");
  lcd.setCursor(0, 1); 
  lcd.print(consumoKWh, 5); lcd.print(" kWh"); 
  delay(3000); 
  
  // Tela 3: Gasto
  lcd.clear();
  lcd.setCursor(0, 0); lcd.print("Gasto da Sessao:");
  lcd.setCursor(0, 1); 
  lcd.print("R$ "); lcd.print(custoReais, 4); 
  delay(4000); 
}

void atualizarLetreiroOcioso() {
  unsigned long currentMillis = millis();
  if (currentMillis - lastDisplayChange >= displayInterval) {
    lastDisplayChange = currentMillis;
    if (showScreenA) {
      RtcDateTime now = Rtc.GetDateTime();
      displayScreenB(now);
      showScreenA = false;
    } else {
      displayScreenA();
      showScreenA = true;
    }
  }
}

// --- LÓGICA PRINCIPAL ---

void processarCartao() {
  RtcDateTime t = Rtc.GetDateTime();
  
  String conteudo = "";
  for (byte i = 0; i < mfrc522.uid.size; i++) {
    conteudo.concat(String(mfrc522.uid.uidByte[i] < 0x10 ? " 0" : " "));
    conteudo.concat(String(mfrc522.uid.uidByte[i], HEX));
  }
  conteudo.toUpperCase();
  String uid = conteudo.substring(1);

  if (uid == "91 42 91 04" || uid == "77 E7 7B 05") { // UIDs Válidos
    beepLiberado();
    
    // Inicia Contagem de Tempo
    inicioUso = millis();
    
    // Ação Hardware (Abre a porta IMEDIATAMENTE)
    microservo9g.write(0);  
    digitalWrite(RELE_PIN, HIGH); 
    setRgbColor(LOW, HIGH, LOW); // Verde
    isSistemaAtivo = true;
    
    // --- SEQUÊNCIA DE TELAS DE ENTRADA ---
    
    // 1. Acesso Liberado
    lcd.clear();
    lcd.setCursor(0, 0); lcd.print("ACESSO LIBERADO!");
    delay(2000); // 2 segundos para ler
    
    // 2. Data e Hora (Padrão Ocioso)
    // Reutilizamos a função displayScreenB para manter o mesmo padrão exato
    displayScreenB(t); 
    delay(2500); // 2.5 segundos para ler a data/hora

    // 3. Bem-Vindo / Iniciando
    lcd.clear();
    lcd.setCursor(0, 0); lcd.print("BEM-VINDO!");
    lcd.setCursor(0, 1); lcd.print("Iniciando Sala");
    delay(2000); 

    // Fecha a cancela
    microservo9g.write(90); 
    displaySistemaAtivo();
    
  } else {
    beepNegado();
    setRgbColor(HIGH, LOW, LOW); // Vermelho
    lcd.clear(); lcd.print("ACESSO NEGADO!");
    delay(2000);
    if (!isSistemaAtivo) {
       setRgbColor(LOW, LOW, HIGH); // Azul
       displayScreenA();
    } else {
       setRgbColor(LOW, HIGH, LOW); // Volta p/ Verde se já estava ativo
       displaySistemaAtivo();
    }
  }
  mfrc522.PICC_HaltA();
  mfrc522.PCD_StopCrypto1();
}

void verificarBotaoDesligamento() {
  if (digitalRead(BOTAO_DESLIGA_PIN) == LOW) {
    // Calcula duração da sessão
    unsigned long fimUso = millis();
    unsigned long duracao = fimUso - inicioUso;
    
    // Desliga Cargas
    digitalWrite(RELE_PIN, LOW);
    isSistemaAtivo = false;
    setRgbColor(LOW, LOW, HIGH); // Azul
    
    // MOSTRA O RELATÓRIO DE ECONOMIA
    displayRelatorioConsumo(duracao);
    
    // Volta ao Ocioso
    displayScreenA();
    lastDisplayChange = millis();
    delay(500); 
  }
}

void setup() {
  lcd.init(); lcd.backlight();
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(RELE_PIN, OUTPUT);
  pinMode(RGB_R_PIN, OUTPUT); pinMode(RGB_G_PIN, OUTPUT); pinMode(RGB_B_PIN, OUTPUT);
  pinMode(BOTAO_DESLIGA_PIN, INPUT_PULLUP);
  
  // Estado inicial
  digitalWrite(RELE_PIN, LOW);
  setRgbColor(LOW, LOW, HIGH); // Azul inicial
  
  microservo9g.attach(3); microservo9g.write(90);
  
  Rtc.Begin();
  SPI.begin(); mfrc522.PCD_Init();
  
  displayScreenA();
}

void loop() {
  if (isSistemaAtivo) {
    verificarBotaoDesligamento();
  }

  if (mfrc522.PICC_IsNewCardPresent() && mfrc522.PICC_ReadCardSerial()) {
    processarCartao();
  } else if (!isSistemaAtivo) {
    atualizarLetreiroOcioso();
  }
}
